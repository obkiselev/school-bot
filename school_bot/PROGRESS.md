# School Bot — Прогресс разработки

## Текущая версия: 0.1.5

## Статус: Фаза 2 в работе — /raspisanie реализована

---

## Общая картина проекта

Сейчас существуют два отдельных проекта:

- **school_bot** (этот проект) — помощник для родителей: расписание, оценки, домашние задания, уведомления. Интеграция с МЭШ.
- **school_helper** (отдельный проект) — помощник для учеников: прохождение тестов по школьным предметам.

**Конечная цель**: объединить оба сервиса в один — **school_bot** — единый школьный сервис и для родителей, и для детей-учеников.

---

## Фаза 1: Фундамент — ЗАВЕРШЕНА

- [x] Структура проекта (модули: core, mesh_api, handlers, keyboards, states, database, notifications, utils)
- [x] Конфигурация через pydantic-settings + .env
- [x] База данных SQLite (aiosqlite) — инициализация, CRUD
- [x] Шифрование паролей (Fernet)
- [x] МЭШ API клиент (auth, client, endpoints, models, exceptions)
- [x] Регистрация пользователей через FSM (логин → пароль → выбор детей → подтверждение)
- [x] Команда /start
- [x] Точка входа bot.py с polling

## Фаза 2: Основные команды — В РАБОТЕ

- [x] /raspisanie — расписание уроков (сегодня/завтра/неделя)
- [x] Автоматическое обновление токена МЭШ (utils/token_manager.py)
- [x] Inline-кнопки переключения периода
- [x] Выбор ребёнка при нескольких детях
- [x] IDOR-защита (проверка владельца student_id)
- [x] HTML-экранирование данных МЭШ API
- [x] Обработка ошибок МЭШ API с кнопкой «Повторить»
- [x] Unit-тесты для расписания (30 тестов, 100% pass)
- [ ] /ocenki — оценки с фильтрацией по датам и предметам
- [ ] /dz — домашние задания
- [ ] Клавиатуры навигации
- [ ] Middleware для проверки аутентификации

## Фаза 3: Уведомления — В ПЛАНАХ

- [ ] APScheduler setup
- [ ] Ежедневные уведомления (18:00 — оценки, 19:00 — ДЗ)
- [ ] /settings — настройка уведомлений
- [ ] Кеширование для определения новых оценок

## Фаза 4: Production — В ПЛАНАХ

- [ ] Логирование (RotatingFileHandler)
- [ ] Rate limiting
- [ ] /help и /profile
- [ ] Деплой на VPS

---

## Известные баги и проблемы

- МЭШ API неофициальное — endpoints могут измениться
- Нет middleware для проверки авторизации перед командами

---

## Changelog

### v0.1.5 — Команда /raspisanie
- Реализована команда /raspisanie — расписание уроков из МЭШ
- Token Manager — автообновление токена МЭШ с asyncio.Lock
- Inline-кнопки: Сегодня / Завтра / Неделя
- Выбор ребёнка при нескольких детях
- IDOR-защита и HTML-экранирование данных API
- Обработка ошибок с кнопкой «Повторить»
- 30 unit-тестов (pytest + pytest-asyncio)

### v0.1.4 — Меню команд бота
- Меню команд бота в Telegram (set_my_commands)

### v0.1.3 — Ограничение доступа
- Белый список пользователей, роли, команды /allow /block /users

### v0.1.0 — Начальная версия
- Создана структура проекта
- Реализована аутентификация через МЭШ
- Регистрация пользователей (FSM)
- Шифрование паролей (Fernet)
- База данных SQLite
- Команда /start
