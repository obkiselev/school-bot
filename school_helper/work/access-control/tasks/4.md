---
status: planned
depends_on: [1, 2, 3]
wave: 3
skills: [pre-deploy-qa]
verify: bash
reviewers: []
teammate_name:
---

# Task 4: Pre-deploy QA

## Required Skills

Before executing this task, load:
- `/skill:pre-deploy-qa` — [skills/pre-deploy-qa/SKILL.md](~/.claude/skills/pre-deploy-qa/SKILL.md)

## Description

Final acceptance testing for the access-control feature. Verify all acceptance criteria from user-spec (AC1-AC14) and tech-spec (TAC1-TAC12) through structural checks. Produce a manual verification checklist for the user to perform hands-on testing via Telegram.

This task does NOT write code. It validates that Tasks 1-3 produced correct, complete, and properly integrated output by running import checks, inspecting file contents, and mapping every acceptance criterion to a concrete verification step.

## What to do

### Step 1: Run structural verification commands

Run each import check from the tech-spec Agent Verification Plan:

1. **Task 1 check — DB migration & access queries:**
   ```
   python -c "from bot.db.database import get_db; from bot.db.queries import is_user_allowed, set_user_access, block_user, get_all_users_list; from bot.config import ADMIN_ID; print('OK')"
   ```

2. **Task 2 check — Access control middleware:**
   ```
   python -c "from bot.middleware.access import AccessControlMiddleware; print('OK')"
   ```

3. **Task 3 check — Admin command handlers:**
   ```
   python -c "from bot.handlers.admin import router; print('OK')"
   ```

All three must print `OK` with no errors.

### Step 2: Check middleware registration in run.py

Open `run.py` and verify:
- `AccessControlMiddleware` is imported from `bot.middleware.access`
- Middleware is registered on both `dp.message.outer_middleware()` and `dp.callback_query.outer_middleware()`

### Step 3: Check admin router registration order

In `run.py`, verify:
- Admin router (`from bot.handlers.admin import router`) is included via `dp.include_router()`
- Admin router is registered BEFORE other routers (start, quiz, etc.) so admin commands take priority

### Step 4: Check .env.example has ADMIN_ID entry

Open `.env.example` and verify it contains an `ADMIN_ID=` line (with or without a placeholder value).

### Step 5: Produce manual verification checklist

Write the final checklist (listed in the Acceptance Criteria and Verification Steps sections below) as output for the user. This checklist maps every AC and TAC to a concrete action the user can perform in Telegram.

## Acceptance Criteria

- [ ] All structural checks pass (imports for DB queries, middleware, admin router all print OK)
- [ ] Middleware is registered as outer middleware on both dp.message and dp.callback_query in run.py
- [ ] Admin router is registered before other routers in run.py
- [ ] .env.example contains ADMIN_ID entry
- [ ] Manual verification checklist produced for user
- [ ] All user-spec AC1-AC14 mapped to verification steps
- [ ] All tech-spec TAC1-TAC12 mapped to verification steps

## Context Files

- [user-spec.md](../user-spec.md) — AC1-AC14 acceptance criteria
- [tech-spec.md](../tech-spec.md) — TAC1-TAC12 technical acceptance criteria, Agent Verification Plan, architecture
- [decisions.md](../decisions.md)
- [task 1](./1.md) — DB migration and access queries
- [task 2](./2.md) — Access control middleware
- [task 3](./3.md) — Admin command handlers

## Verification Steps

### Automated structural checks (agent performs)

| # | Check | Command / Action | Expected |
|---|-------|-----------------|----------|
| S1 | DB functions & config exist | `python -c "from bot.db.database import get_db; from bot.db.queries import is_user_allowed, set_user_access, block_user, get_all_users_list; from bot.config import ADMIN_ID; print('OK')"` | Prints `OK` |
| S2 | Middleware class exists | `python -c "from bot.middleware.access import AccessControlMiddleware; print('OK')"` | Prints `OK` |
| S3 | Admin router exists | `python -c "from bot.handlers.admin import router; print('OK')"` | Prints `OK` |
| S4 | Middleware registration | Inspect `run.py` for `dp.message.outer_middleware` and `dp.callback_query.outer_middleware` | Both present |
| S5 | Router order | Inspect `run.py` — admin router included before other routers | Admin router first |
| S6 | .env.example | Inspect `.env.example` for `ADMIN_ID` line | Present |

### Manual verification checklist (user performs via Telegram)

| # | Maps to | Action | Expected Result |
|---|---------|--------|----------------|
| M1 | AC1, TAC1 | Write to bot from account NOT in whitelist | Bot responds: "Доступ ограничен. Обратитесь к администратору." |
| M2 | AC2 | `/allow child_ID` from admin account | Bot confirms: user added with role student |
| M3 | AC3 | `/allow child_ID admin` from admin account | Bot confirms: user added with role admin |
| M4 | AC4 | `/allow` for already existing user with different role | Role updated, user unblocked |
| M5 | AC5, TAC4 | `/block child_ID` then child tries to start new test | Child sees "Доступ ограничен", cannot start new test |
| M6 | AC5, TAC4 | Start test, then `/block child_ID` from admin | Child can finish current test (answer remaining questions, see result) |
| M7 | AC6 | `/block` already blocked user | Bot responds: "Пользователь уже заблокирован" |
| M8 | AC7 | `/users` from admin account | Bot shows list with names, roles, statuses for all users |
| M9 | AC8 | `/allow`, `/block`, `/users` from non-admin account | Commands not available / no response |
| M10 | AC9, TAC3, TAC9 | `/block ADMIN_ID` from another admin account | Bot responds: "Нельзя заблокировать главного администратора" |
| M11 | AC10 | `/block own_ID` from admin account | Bot responds: "Нельзя заблокировать самого себя" |
| M12 | AC11 | Admin blocks another admin (not ADMIN_ID) | Block succeeds |
| M13 | AC12, TAC12 | `/allow abc` (non-numeric ID) | Bot shows usage hint: "Используй: /allow 123456789 [student\|admin]" |
| M14 | AC13, TAC2 | Restart bot multiple times | No migration errors, existing data preserved |
| M15 | AC14 | Send admin command in a group chat | Command ignored or error (private chat only) |
| M16 | TAC5 | Click an inline button while blocked | Spinner dismissed (no hang), "Доступ ограничен" shown |
| M17 | TAC6 | Inspect run.py | Admin router registered before other routers |
| M18 | TAC7 | Check requirements.txt | No new dependencies added |
| M19 | TAC8 | Check .env.example | Contains `ADMIN_ID=` entry |
| M20 | TAC10 | (Edge case) DB failure scenario | Blocked users stay blocked; ADMIN_ID still has access |
| M21 | TAC11 | `/allow` a previously blocked user | User is unblocked and role is set |

## Details

**Files to inspect:**
- `run.py` — middleware registration, router order
- `bot/middleware/access.py` — AccessControlMiddleware class
- `bot/handlers/admin.py` — admin router and command handlers
- `bot/db/database.py` — migration logic
- `bot/db/queries.py` — is_user_allowed, set_user_access, block_user, get_all_users_list
- `bot/config.py` — ADMIN_ID loading and validation
- `.env.example` — ADMIN_ID placeholder

**Dependencies:** Tasks 1, 2, and 3 must all be completed before this task can run.

**Edge cases:**
- Import checks may fail if any task left syntax errors — report exact error message
- Middleware may be registered but as inner middleware instead of outer — must be outer
- Admin router may exist but not be included in dispatcher — check `dp.include_router()`
- .env.example may not exist at all — flag as missing

**Implementation hints:**
- Use `grep` or file reading to verify middleware registration — look for `outer_middleware` in run.py
- Check router order by looking at the sequence of `dp.include_router()` calls
- The checklist output should be formatted as a clear, numbered list that the user can follow step by step

## Reviewers

QA task is its own verification — no external reviewers needed.

## Post-completion

- [ ] Record brief summary in decisions.md (Summary: 1-3 sentences, no findings tables)
- [ ] If any structural check failed — document the failure and resolution
- [ ] Update user-spec/tech-spec if any acceptance criteria needed adjustment
