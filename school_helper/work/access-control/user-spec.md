---
created: 2026-02-26
status: approved
type: feature
size: M
---

# User Spec: Ограничение доступа к боту

## Что делаем

Добавляем систему контроля доступа к Telegram-боту. Только пользователи из белого списка (whitelist) могут пользоваться ботом. Управление списком — через админ-команды прямо в боте (/allow, /block, /users). У каждого пользователя есть роль (admin или student) и статус (активен или заблокирован).

## Зачем

Бот сейчас доступен любому, кто найдёт его в Telegram. Это семейный учебный бот, и посторонним он не нужен. Ограничение доступа защищает приватность семьи и предотвращает нецелевое использование.

## Как должно работать

### Сценарий 1: Первый запуск после обновления
1. Владелец добавляет свой Telegram ID в `.env` как `ADMIN_ID`
2. Запускает бота
3. Бот автоматически мигрирует базу данных — добавляет колонки role и is_blocked
4. Пользователь с ADMIN_ID получает роль admin, остальные существующие — student, все активны

### Сценарий 2: Админ добавляет пользователя
1. Админ пишет `/allow 123456789` — добавляет пользователя как student
2. Или `/allow 123456789 admin` — добавляет как admin
3. Бот отвечает подтверждением: "✅ Пользователь 123456789 добавлен (роль: student)"
4. Ребёнок пишет `/start` и видит обычное главное меню

### Сценарий 3: Неразрешённый пользователь
1. Посторонний пишет боту любое сообщение или нажимает любую кнопку
2. Бот отвечает: "❗ Доступ ограничен. Обратитесь к администратору."
3. Никакие действия не доступны

### Сценарий 4: Блокировка пользователя
1. Админ пишет `/block 123456789`
2. Если пользователь сейчас в процессе теста — он может ответить на все оставшиеся вопросы и увидеть результат
3. После завершения теста, при следующем действии — видит "Доступ ограничен"
4. Новый тест начать нельзя
5. При нажатии на старые inline-кнопки из прошлых сообщений — тоже "Доступ ограничен" (кнопка снимается через callback.answer())

### Сценарий 5: Просмотр списка пользователей
1. Админ пишет `/users`
2. Бот показывает таблицу: имя, роль, статус (активен/заблокирован) для каждого пользователя

## Критерии приёмки

- [ ] AC1: Неразрешённый пользователь видит "❗ Доступ ограничен. Обратитесь к администратору." на любое действие (сообщение или кнопка)
- [ ] AC2: `/allow 123456789` добавляет пользователя с ролью student (по умолчанию)
- [ ] AC3: `/allow 123456789 admin` добавляет пользователя с ролью admin
- [ ] AC4: `/allow` для уже существующего пользователя обновляет его роль и разблокирует
- [ ] AC5: `/block 123456789` блокирует пользователя. Текущий тест можно докончить, новый начать нельзя
- [ ] AC6: `/block` уже заблокированного — сообщение "Пользователь уже заблокирован"
- [ ] AC7: `/users` показывает список: имя, роль, статус для каждого пользователя
- [ ] AC8: Команды /allow, /block, /users доступны только админам
- [ ] AC9: Главный админ (ADMIN_ID из .env) не может быть удалён или заблокирован
- [ ] AC10: Админ не может заблокировать самого себя
- [ ] AC11: Админ может заблокировать другого админа
- [ ] AC12: При неправильном формате команды — подсказка с примером: "Используй: /allow 123456789 [student|admin]"
- [ ] AC13: При запуске бот мигрирует базу данных: добавляет role и is_blocked к таблице users. ADMIN_ID → admin, остальные → student, все активны. Миграция безопасна при повторных запусках (идемпотентна).
- [ ] AC14: Админ-команды работают только в личных сообщениях боту (не в группах)

## Ограничения

- Без новых зависимостей — используем aiogram BaseMiddleware и aiosqlite
- SQLite — поддерживает ALTER TABLE ADD COLUMN для миграции
- Бот запускается локально, без CI/CD
- Идентификация по числовому Telegram ID (не по username — он может меняться)

## Риски

- **Риск 1:** Все админы заблокированы, никто не может управлять ботом. **Митигация:** ADMIN_ID из .env неудаляем и незаблокируем — всегда есть хотя бы один активный админ.
- **Риск 2:** FSM-состояние "зависает" при блокировке пользователя во время теста. **Митигация:** Используется MemoryStorage — состояние очистится при перезапуске бота. Плюс текущий тест можно докончить.
- **Риск 3:** Миграция базы данных ломает существующих пользователей. **Митигация:** Все существующие пользователи остаются активными, получают роль student. ALTER TABLE ADD COLUMN безопасна.

## Технические решения

- Whitelist хранится в базе данных (не в конфиг-файле), чтобы управлять доступом через бота без перезапуска.
- Проверка доступа происходит автоматически на каждое действие пользователя (до обработки команд).
- Первый админ задаётся через ADMIN_ID в .env — без этого контроль доступа не включается.
- Роли: admin и student.
- Блокировка мягкая: текущий тест можно докончить, проверка при каждом новом действии.

## Тестирование

**Unit-тесты:** не делаем в этом проекте — проект семейный, маленький, без CI/CD. Логика проверки доступа простая. Ручная проверка достаточна.

**Интеграционные тесты:** не делаем — та же причина.

**E2E тесты:** не делаем.

## Как проверить

### Агент проверяет

Бот запускается локально и требует Telegram-аккаунт для взаимодействия. Автоматическая проверка агентом невозможна — проверяет пользователь вручную.

### Пользователь проверяет
- Написать боту с аккаунта, которого нет в whitelist → должен увидеть "Доступ ограничен"
- Написать `/allow ID_ребёнка` с админского аккаунта → должно быть подтверждение
- Написать `/start` с аккаунта ребёнка → должно появиться обычное главное меню
- Написать `/block ID_ребёнка` → заблокировать, проверить что новый тест начать нельзя
- Написать `/users` → увидеть список всех пользователей с ролями и статусами
- Попробовать `/block` свой ID → должна быть ошибка "Нельзя заблокировать самого себя"
- Написать `/allow abc` → должна быть подсказка с правильным форматом
